<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ShakeCraft v4.0: THE ARC</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a2e; font-family: 'Roboto Mono', monospace; user-select: none; touch-action: none; }
        
        /* UI Layer */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }

        /* –°—á–µ—Ç—á–∏–∫–∏ */
        .header { padding: 20px; display: flex; justify-content: space-between; text-shadow: 2px 2px 0 #000; }
        .stat-box { color: white; font-size: 18px; font-weight: bold; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; }
        .gem-cnt { color: #00D9FF; }
        .height-cnt { color: #FFD700; }

        /* –ó–æ–Ω—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–¢–∞–ø—ã) */
        .tap-zone {
            position: absolute; top: 0; height: 100%; width: 50%;
            pointer-events: auto; z-index: 5; opacity: 0; transition: opacity 0.1s;
            background: rgba(255, 255, 255, 0.1);
        }
        .tap-left { left: 0; border-right: 1px solid rgba(255,255,255,0.1); }
        .tap-right { right: 0; }
        .tap-active { opacity: 1; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–ê—Ä–∫–∞, –û—Å—ã–ø–∞–Ω–∏–µ) */
        #message-area {
            position: absolute; top: 20%; width: 100%; text-align: center;
            font-family: 'Black Ops One', cursive; color: white;
            text-shadow: 0 0 10px red; font-size: 24px; display: none;
        }
        
        /* –ü–æ–±–µ–¥–Ω—ã–π —ç–∫—Ä–∞–Ω */
        #win-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 99; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center;
        }
        .rank-title { font-family: 'Black Ops One'; font-size: 40px; margin-bottom: 10px; color: gold; }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–º–æ–Ω—Ç–∞ */
        .repair-fx {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; font-weight: bold; color: #00D9FF; opacity: 0;
            pointer-events: none; text-shadow: 0 0 10px blue;
        }
        @keyframes floatUp { 0% { transform: translate(-50%, -50%); opacity: 1; } 100% { transform: translate(-50%, -150%); opacity: 0; } }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>
<body>

    <!-- UI -->
    <div id="ui-layer">
        <div class="header">
            <div class="stat-box height-cnt">H: <span id="h-val">0</span></div>
            <div class="stat-box gem-cnt">üíé: <span id="g-val">0</span></div>
        </div>
        <div id="message-area">‚ö†Ô∏è CRITICAL LEAN ‚ö†Ô∏è</div>
    </div>

    <!-- –°–µ–Ω—Å–æ—Ä–Ω—ã–µ –∑–æ–Ω—ã -->
    <div class="tap-zone tap-left" id="zone-left" onpointerdown="repair('left')"></div>
    <div class="tap-zone tap-right" id="zone-right" onpointerdown="repair('right')"></div>

    <!-- –≠—Ñ—Ñ–µ–∫—Ç –ø–æ—á–∏–Ω–∫–∏ -->
    <div id="repair-anim" class="repair-fx">+REPAIR</div>

    <!-- –ü–æ–±–µ–¥–Ω—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="win-screen">
        <div style="font-size: 20px; color: #ccc;">ARCH COMPLETED</div>
        <div class="rank-title" id="rank-text">GOLDEN ARC</div>
        <div style="margin-bottom: 30px;">Final Size: <span id="final-score">0</span> blocks</div>
        <button onclick="location.reload()" style="padding: 20px 40px; font-size: 20px; background: #5da81e; color: white; border: none; border-radius: 10px;">BUILD AGAIN</button>
    </div>

    <script>
        // --- CONFIG ---
        const CFG = {
            gravity: 0.0003,      // –°–∏–ª–∞ –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏ (–Ω–∞—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä–æ –ø–∞–¥–∞–µ—Ç)
            repairPower: 0.05,    // –°–∏–ª–∞ –æ–¥–Ω–æ–≥–æ —Ç–∞–ø–∞ (–Ω–∞—Å–∫–æ–ª—å–∫–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç)
            shakeThreshold: 15,   // –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä—è—Å–∫–∏
            gemChance: 0.3,       // –®–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å –∞–ª–º–∞–∑ –ø—Ä–∏ –±–ª–æ–∫–µ
            criticalAngle: 1.2,   // –£–≥–æ–ª (—Ä–∞–¥–∏–∞–Ω—ã), –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–º –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ—Å—ã–ø–∞–Ω–∏–µ (~70 –≥—Ä–∞–¥—É—Å–æ–≤)
            crumbleSpeed: 5       // –ö–∞–∫ —á–∞—Å—Ç–æ –ø–∞–¥–∞—é—Ç –±–ª–æ–∫–∏ (–∫–∞–∂–¥—ã–µ X –∫–∞–¥—Ä–æ–≤)
        };

        // --- STATE ---
        const STATE = {
            blocks: [],         // –ú–∞—Å—Å–∏–≤ –º–µ—à–µ–π
            gems: 5,            // –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –∞–ª–º–∞–∑—ã
            leanVelocity: 0,    // –°–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è
            currentLean: 0,     // –¢–µ–∫—É—â–∏–π —É–≥–æ–ª –Ω–∞–∫–ª–æ–Ω–∞ (0 = —Å—Ç–æ–∏—Ç —Ä–æ–≤–Ω–æ)
            isGameOver: false,
            crumbleCounter: 0,
            isStabilized: true  // –ü–æ–∫–∞ –º–∞–ª–µ–Ω—å–∫–∏–π - —Å—Ç–æ–∏—Ç –∫—Ä–µ–ø–∫–æ
        };

        // --- AUDIO ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'build') {
                osc.frequency.setValueAtTime(200 + (STATE.blocks.length * 2), now);
                osc.frequency.exponentialRampToValueAtTime(100, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            } else if (type === 'repair') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.linearRampToValueAtTime(1000, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'win') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(400, now);
                osc.frequency.linearRampToValueAtTime(800, now + 1);
                gain.gain.setValueAtTime(0.5, now);
                gain.gain.linearRampToValueAtTime(0, now + 2);
                osc.start(now); osc.stop(now + 2);
            } else if (type === 'crumble') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.1);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            }
        }

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a2e);
        scene.fog = new THREE.Fog(0x1a1a2e, 20, 100);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 15);
        camera.lookAt(0, 5, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.body.appendChild(renderer.domElement);

        // –°–≤–µ—Ç
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(10, 20, 10);
        dirLight.castShadow = true;
        scene.add(dirLight);
        scene.add(new THREE.AmbientLight(0x404040));

        // –ó–µ–º–ª—è (–ë–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ø–ª–æ—Å–∫–æ—Å—Ç—å)
        const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x222222 }));
        ground.rotation.x = -Math.PI / 2;
        ground.receiveShadow = true;
        scene.add(ground);

        // –ë–∞—à–Ω—è (–ì—Ä—É–ø–ø–∞)
        const towerGroup = new THREE.Group();
        scene.add(towerGroup);

        // –ú–∞—Ç–µ—Ä–∏–∞–ª—ã
        const matBase = new THREE.MeshStandardMaterial({ color: 0x8B4513 });
        const matGem = new THREE.MeshStandardMaterial({ color: 0x00FFFF, emissive: 0x004444 });

        // --- LOGIC ---

        function addBlock() {
            if (STATE.isGameOver) return;

            const h = STATE.blocks.length;
            const geo = new THREE.BoxGeometry(1, 1, 1);
            
            // –®–∞–Ω—Å –Ω–∞ –∞–ª–º–∞–∑ (–≤–∏–∑—É–∞–ª—å–Ω–æ)
            const isGem = Math.random() < 0.05; 
            const mat = isGem ? matGem : matBase;

            const mesh = new THREE.Mesh(geo, mat);
            
            // –ü–æ–∑–∏—Ü–∏—è –ª–æ–∫–∞–ª—å–Ω–∞—è (–ø—Ä–æ—Å—Ç–æ –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞ –ø–æ Y)
            mesh.position.y = h + 0.5; 
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫ –≥—Ä—É–ø–ø–µ
            towerGroup.add(mesh);
            STATE.blocks.push(mesh);

            // –î–∞–µ–º –≤–∞–ª—é—Ç—É
            if (Math.random() < CFG.gemChance) {
                STATE.gems++;
                updateUI();
            }

            // –ó–≤—É–∫
            playSound('build');
            updateUI();

            // –ï—Å–ª–∏ –±–∞—à–Ω—è –≤—ã—Ä–æ—Å–ª–∞, –æ–Ω–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–π
            if (h > 5) STATE.isStabilized = false;
        }

        // –†–µ–º–æ–Ω—Ç (–¢–∞–ø)
        window.repair = function(side) {
            if (STATE.isGameOver) return;

            if (STATE.gems > 0) {
                STATE.gems--;
                
                // –§–∏–∑–∏–∫–∞ —Ç–æ–ª—á–∫–∞
                if (side === 'left') {
                    STATE.leanVelocity += CFG.repairPower; // –¢–æ–ª–∫–∞–µ–º –≤–ø—Ä–∞–≤–æ (+)
                    flashZone('zone-left');
                } else {
                    STATE.leanVelocity -= CFG.repairPower; // –¢–æ–ª–∫–∞–µ–º –≤–ª–µ–≤–æ (-)
                    flashZone('zone-right');
                }

                // –í–∏–∑—É–∞–ª
                playSound('repair');
                showRepairAnim();
                updateUI();
            }
        };

        function flashZone(id) {
            const el = document.getElementById(id);
            el.classList.add('tap-active');
            setTimeout(() => el.classList.remove('tap-active'), 100);
        }

        function showRepairAnim() {
            const el = document.getElementById('repair-anim');
            el.style.animation = 'none';
            el.offsetHeight; /* trigger reflow */
            el.style.animation = 'floatUp 0.5s forwards';
        }

        // --- PHYSICS LOOP ---
        function updatePhysics() {
            if (STATE.isGameOver) return;

            const height = STATE.blocks.length;
            if (height < 3) return;

            // 1. –ì—Ä–∞–≤–∏—Ç–∞—Ü–∏—è (–í–ª–∏—è–µ—Ç –Ω–∞ –Ω–∞–∫–ª–æ–Ω)
            // –ß–µ–º –≤—ã—à–µ –±–∞—à–Ω—è, —Ç–µ–º —Å–∏–ª—å–Ω–µ–µ –æ–Ω–∞ —Ö–æ—á–µ—Ç —É–ø–∞—Å—Ç—å (—Ä—ã—á–∞–≥)
            let leverage = height * 0.0005; 
            
            // –ï—Å–ª–∏ –Ω–∞–∫–ª–æ–Ω –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π (–≤–ø—Ä–∞–≤–æ), –≥—Ä–∞–≤–∏—Ç–∞—Ü–∏—è —Ç—è–Ω–µ—Ç –µ—â–µ —Å–∏–ª—å–Ω–µ–µ –≤–ø—Ä–∞–≤–æ
            // –ï—Å–ª–∏ –Ω–∞–∫–ª–æ–Ω –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π (–≤–ª–µ–≤–æ), —Ç—è–Ω–µ—Ç –≤–ª–µ–≤–æ
            if (STATE.currentLean > 0) STATE.leanVelocity += CFG.gravity + leverage;
            else if (STATE.currentLean < 0) STATE.leanVelocity -= CFG.gravity + leverage;
            else {
                // –ï—Å–ª–∏ —Å—Ç–æ–∏—Ç –∏–¥–µ–∞–ª—å–Ω–æ —Ä–æ–≤–Ω–æ, —Å–ª—É—á–∞–π–Ω—ã–π –≤–µ—Ç–µ—Ä–æ–∫
                if (!STATE.isStabilized) STATE.leanVelocity += (Math.random() - 0.5) * 0.001;
            }

            // –¢—Ä–µ–Ω–∏–µ –≤–æ–∑–¥—É—Ö–∞ (–∑–∞—Ç—É—Ö–∞–Ω–∏–µ)
            STATE.leanVelocity *= 0.98;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å
            STATE.currentLean += STATE.leanVelocity;

            // 2. –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ò–∑–≥–∏–±–∞ (Bending)
            // –ú—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ –≤—Ä–∞—â–∞–µ–º –≥—Ä—É–ø–ø—É, –º—ã –∏–∑–≥–∏–±–∞–µ–º –µ—ë
            // –ö–∞–∂–¥–æ–º—É –±–ª–æ–∫—É –¥–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
            
            // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π –∏–∑–≥–∏–±: –ø—Ä–æ—Å—Ç–æ –≤—Ä–∞—â–∞–µ–º –≤—Å—é –≥—Ä—É–ø–ø—É –¥–ª—è MVP, 
            // –Ω–æ —Å–º–µ—â–∞–µ–º —Ü–µ–Ω—Ç—Ä –≤—Ä–∞—â–µ–Ω–∏—è –≤–Ω–∏–∑
            towerGroup.rotation.z = -STATE.currentLean; // ThreeJS rotation Z is counter-clockwise

            // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ê—Ä–∫—É (–ü–æ–±–µ–¥–∞)
            // –í–µ—Ä—à–∏–Ω–∞ –±–∞—à–Ω–∏
            const tipBlock = STATE.blocks[height - 1];
            
            // –ü–æ–ª—É—á–∞–µ–º –º–∏—Ä–æ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–µ—Ä—à–∏–Ω—ã
            const tipPos = new THREE.Vector3();
            tipBlock.getWorldPosition(tipPos);

            // –£—Å–ª–æ–≤–∏–µ –ø–æ–±–µ–¥—ã: –í–µ—Ä—à–∏–Ω–∞ –∫–æ—Å–Ω—É–ª–∞—Å—å –∑–µ–º–ª–∏ (Y < 0.5) –ò –º—ã –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–ª–µ–∫–æ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ (X > 5)
            // –ß—Ç–æ–±—ã –Ω–µ –≤—ã–∏–≥—Ä–∞—Ç—å –ø—Ä–æ—Å—Ç–æ —É–ø–∞–≤ –º–∞–ª–µ–Ω—å–∫–æ–π –ø–∞–ª–∫–æ–π
            if (tipPos.y <= 0.5 && Math.abs(tipPos.x) > 5) {
                triggerWin();
            }

            // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –û—Å—ã–ø–∞–Ω–∏–µ (–ü–æ—Ä–∞–∂–µ–Ω–∏–µ/–®—Ç—Ä–∞—Ñ)
            // –ï—Å–ª–∏ –Ω–∞–∫–ª–æ–Ω –±–æ–ª—å—à–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ, –Ω–æ –º—ã –µ—â–µ –Ω–µ –∫–æ—Å–Ω—É–ª–∏—Å—å –∑–µ–º–ª–∏
            if (Math.abs(STATE.currentLean) > CFG.criticalAngle && tipPos.y > 1) {
                document.getElementById('message-area').style.display = 'block';
                STATE.crumbleCounter++;
                
                if (STATE.crumbleCounter > CFG.crumbleSpeed) {
                    crumbleTop();
                    STATE.crumbleCounter = 0;
                }
            } else {
                document.getElementById('message-area').style.display = 'none';
            }

            // 5. –ö–∞–º–µ—Ä–∞ (Auto Zoom)
            // –ö–∞–º–µ—Ä–∞ –¥–æ–ª–∂–Ω–∞ –≤–∏–¥–µ—Ç—å –∏ –æ—Å–Ω–æ–≤–∞–Ω–∏–µ (0,0) –∏ –≤–µ—Ä—à–∏–Ω—É (tipPos)
            // –ù–∞—Ö–æ–¥–∏–º —Ü–µ–Ω—Ç—Ä –º–µ–∂–¥—É –Ω–∏–º–∏
            const midX = tipPos.x / 2;
            const midY = tipPos.y / 2;
            
            // –î–∏—Å—Ç–∞–Ω—Ü–∏—è –∫–∞–º–µ—Ä—ã –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—ã—Å–æ—Ç—ã –±–∞—à–Ω–∏
            const targetZ = 15 + (height * 1.5);
            
            // –ü–ª–∞–≤–Ω—ã–π Lerp –∫–∞–º–µ—Ä—ã
            camera.position.x += (midX - camera.position.x) * 0.05;
            camera.position.y += (midY - camera.position.y) * 0.05;
            camera.position.z += (targetZ - camera.position.z) * 0.05;
            camera.lookAt(midX, midY, 0);
        }

        function crumbleTop() {
            if (STATE.blocks.length === 0) return;
            
            // –£–¥–∞–ª—è–µ–º –≤–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫
            const mesh = STATE.blocks.pop();
            towerGroup.remove(mesh);
            
            // –°–æ–∑–¥–∞–µ–º –ø–∞–¥–∞—é—â–∏–π –º—É—Å–æ—Ä (–≤–∏–∑—É–∞–ª)
            const debris = mesh.clone();
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –º–∏—Ä–µ, —á—Ç–æ–±—ã –æ—Ç—Ü–µ–ø–∏—Ç—å –æ—Ç –≥—Ä—É–ø–ø—ã
            const worldPos = new THREE.Vector3();
            mesh.getWorldPosition(worldPos);
            
            debris.position.copy(worldPos);
            debris.rotation.copy(mesh.rotation);
            scene.add(debris);

            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–¥–µ–Ω–∏—è –º—É—Å–æ—Ä–∞ (–ø—Ä–æ—Å—Ç–∞—è)
            let velY = 0;
            const fallInterval = setInterval(() => {
                velY -= 0.02;
                debris.position.y += velY;
                debris.rotation.x += 0.1;
                if (debris.position.y < -5) {
                    clearInterval(fallInterval);
                    scene.remove(debris);
                }
            }, 16);

            playSound('crumble');
            updateUI();
            
            // –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞–∫–ª–æ–Ω (–±–∞—à–Ω—è —Å—Ç–∞–ª–∞ –ª–µ–≥—á–µ —Å–≤–µ—Ä—Ö—É)
            STATE.leanVelocity *= 0.5; 
        }

        function triggerWin() {
            STATE.isGameOver = true;
            playSound('win');
            
            const score = STATE.blocks.length;
            let rank = "WOODEN ARC";
            let color = "#8B4513";

            if (score > 20) { rank = "IRON ARC"; color = "#aaa"; }
            if (score > 40) { rank = "GOLD ARC"; color = "gold"; }
            if (score > 60) { rank = "PLATINUM ARC"; color = "#e5e4e2"; }
            if (score > 80) { rank = "DIAMOND ARC"; color = "#00D9FF"; }

            document.getElementById('rank-text').innerText = rank;
            document.getElementById('rank-text').style.color = color;
            document.getElementById('final-score').innerText = score;
            document.getElementById('win-screen').style.display = 'flex';
        }

        function updateUI() {
            document.getElementById('h-val').innerText = STATE.blocks.length;
            document.getElementById('g-val').innerText = STATE.gems;
        }

        // --- INPUT HANDLING ---
        
        let lastX = 0, lastY = 0, lastZ = 0;

        // Shake Event
        window.addEventListener('devicemotion', (e) => {
            if (STATE.isGameOver) return;
            
            const acc = e.accelerationIncludingGravity;
            if (!acc) return;

            const dx = Math.abs(acc.x - lastX);
            const dy = Math.abs(acc.y - lastY);
            const dz = Math.abs(acc.z - lastZ);

            if (dx + dy + dz > CFG.shakeThreshold) {
                addBlock();
                
                // –¢—Ä—è—Å–∫–∞ –Ω–µ–º–Ω–æ–≥–æ –¥–µ—Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä—É–µ—Ç –±–∞—à–Ω—é (—Ä–∏—Å–∫!)
                STATE.leanVelocity += (Math.random() - 0.5) * 0.005;
            }

            lastX = acc.x; lastY = acc.y; lastZ = acc.z;
        });

        // --- RENDER LOOP ---
        function animate() {
            requestAnimationFrame(animate);
            updatePhysics();
            renderer.render(scene, camera);
        }
        animate();

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // –ó–∞–ø—Ä–æ—Å –ø—Ä–∞–≤ –¥–ª—è iOS (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å)
        document.body.addEventListener('click', () => {
            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission();
            }
        }, { once: true });

    </script>
</body>
</html>
